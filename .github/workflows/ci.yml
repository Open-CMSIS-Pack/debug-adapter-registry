name: debug-adapter-registry
on:
  pull_request:
    paths:
      - '.github/workflows/ci.yml'
      - 'registry/**'
      - 'schemas/**'
      - 'templates/**'
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  tests:
    if: |
      ${{ github.event_name == 'pull_request' || github.event_name == 'release' }}
    timeout-minutes: 15
    runs-on: ubuntu-latest
    name: 'Check schemas of registry and templates'

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Lint registry and templates
        run: |
          npm ci
          npm run lint

      - name: Check registry schema
        uses: GrantBirki/json-yaml-validate@v4.0.0
        with:
          base_dir: registry
          json_schema: schemas/debug-adapters.schema.json
          yaml_as_json: true
          ajv_strict_mode: false
          use_gitignore: false

      - name: Check templates schemas
        uses: GrantBirki/json-yaml-validate@v4.0.0
        with:
          base_dir: templates
          json_schema: schemas/templates.schema.json
          ajv_strict_mode: false
          use_gitignore: false

  release:
    if: ${{ github.event_name == 'release' }}
    needs: [ tests ]
    timeout-minutes: 15
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ZIP files
        run: zip -r debug-adapter-registry.zip registry schemas templates

      - name: TAR files
        run: tar -czf debug-adapter-registry.tar.gz registry schemas templates

      - name: Attach files to release assets
        id: release_assets
        uses: svenstaro/upload-release-action@6b7fa9f267e90b50a19fef07b3596790bb941741 # v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: debug-adapter-registry.*
          tag: ${{ github.ref }}
          overwrite: true
          file_glob: true
